<!-- Search Bar Component -->
<div x-data="{ showSuggestions: false, suggestions: [], selectedIndex: -1 }" 
     @click.away="showSuggestions = false"
     class="relative">
<form id="search-form" 
      hx-get="{% url 'catalog:search' %}" 
      hx-target="#products-grid" 
      hx-indicator="#search-loading"
      hx-trigger="submit, input changed delay:300ms from:#search-input">
    
    <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </div>
        
        <input type="text" 
               id="search-input"
               name="q"
               x-model="searchQuery"
               @input="if (searchQuery.length >= 2) { 
                   fetch('/api/search-suggestions/?q=' + encodeURIComponent(searchQuery))
                   .then(r => r.json())
                   .then(data => { suggestions = data.suggestions; showSuggestions = true; selectedIndex = -1; })
                   .catch(() => suggestions = []);
               } else { showSuggestions = false; }"
               @keydown.arrow-down.prevent="selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1)"
               @keydown.arrow-up.prevent="selectedIndex = Math.max(selectedIndex - 1, -1)"
               @keydown.enter.prevent="if (selectedIndex >= 0) { searchQuery = suggestions[selectedIndex].text; showSuggestions = false; } $el.form.dispatchEvent(new Event('submit'));"
               @keydown.escape="showSuggestions = false"
               @focus="if (searchQuery.length >= 2 && suggestions.length > 0) showSuggestions = true"
               class="search-bar pl-10 pr-12" 
               placeholder="Buscar produtos, marcas de celular, categorias, fabricantes..."
               autocomplete="off">
        
        <!-- Clear Search Button -->
        <div class="absolute inset-y-0 right-0 flex items-center">
            <!-- Loading Indicator -->
            <div id="search-loading" class="htmx-indicator mr-3">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-orange-500"></div>
            </div>
            
            <!-- Clear Button -->
            <button type="button" 
                    x-show="searchQuery.length > 0"
                    @click="searchQuery = ''; showSuggestions = false; htmx.trigger('#search-form', 'submit')"
                    class="mr-3 text-gray-400 hover:text-gray-600"
                    style="display: none;">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Hidden inputs for filters -->
    <input type="hidden" name="category" x-model="selectedCategory">
    <input type="hidden" name="sort" x-model="sortBy">
</form>

<!-- Search Suggestions -->
<div x-show="showSuggestions && suggestions.length > 0" 
     x-transition:enter="transition ease-out duration-200"
     x-transition:enter-start="opacity-0 translate-y-1"
     x-transition:enter-end="opacity-100 translate-y-0"
     x-transition:leave="transition ease-in duration-150"
     x-transition:leave-start="opacity-100 translate-y-0"
     x-transition:leave-end="opacity-0 translate-y-1"
     class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-b-lg shadow-lg z-20 max-h-60 overflow-y-auto"
     style="display: none;">
    <template x-for="(suggestion, index) in suggestions" :key="index">
        <button type="button"
                @click="searchQuery = suggestion.text; showSuggestions = false; htmx.trigger('#search-form', 'submit')"
                :class="selectedIndex === index ? 'bg-orange-50 text-orange-700' : 'hover:bg-gray-50'"
                class="w-full px-4 py-3 text-left flex items-center justify-between border-b border-gray-100 last:border-b-0 transition-colors">
            <div class="flex items-center space-x-3">
                <!-- Type Icon -->
                <div class="flex-shrink-0">
                    <svg x-show="suggestion.type === 'categoria'" class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                    <svg x-show="suggestion.type === 'marca'" class="w-4 h-4 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                    </svg>
                    <svg x-show="suggestion.type === 'produto'" class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2L3 7v11a1 1 0 001 1h12a1 1 0 001-1V7l-7-5zM8 12a1 1 0 012 0v2a1 1 0 01-2 0v-2z" clip-rule="evenodd"/>
                    </svg>
                </div>
                
                <!-- Suggestion Text -->
                <div>
                    <div class="font-medium text-gray-900" x-text="suggestion.text"></div>
                    <div class="text-xs text-gray-500 capitalize" x-text="suggestion.type"></div>
                </div>
            </div>
            
            <!-- Arrow Icon -->
            <div class="flex-shrink-0 text-gray-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
        </button>
    </template>
</div>
</div>